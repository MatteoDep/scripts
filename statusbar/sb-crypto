#!/bin/sh

# Shows the price for desired cryptocurrencies. Module updates automatically
# every calendar day, but can also be updated with a middle click.

# coins to print
coins="btc eth"

# Directory where currency info is stored.
dir="${XDG_DATA_HOME:-$HOME/.local/share}/crypto-prices"

printprices() { # Print/format all prices
	for coin in $coins; do
        coinfile="$dir/$coin-price"
		[ -f "$coinfile" ] || continue
        sed 's/^\(.\);\([0-9\.]*\)\(.\);.*/\1 \2 \3/' $coinfile | {
            read icon value ref
            printf "%s%.2f%s " $icon $value $ref
        }
	done | sed 's/ $/\n/'
	}

case $BUTTON in
	1) cat "$dir"/*-chart > /tmp/cryptocharts
       setsid "$TERMINAL" -e less -SRf /tmp/cryptocharts
       rm /tmp/cryptocharts;;
    2) unset BUTTON; setsid -f crypto-update >/dev/null; exit ;;
	3) uptime="$(date -d "$(stat -c %x "$dir")" '+%D at %T' | sed "s|$(date '+%D')|Today|")"
        notify-send "Crypto-currency module" "\- Right check all crypto prices.
- Middle click to update.
- Right click to see 7 days charts.
- Manually add/remove currencies to list in the script.
Exact prices:
$(awk -F';' '{print $1, $3 ":\n\t" $2}' "$dir"/*-price)
<b>Last updated:</b>$uptime" ;;
	6) "$TERMINAL" -e "$EDITOR" "$0" ;;
esac

[ -e /tmp/cryptoupdate ] && {
    cat /tmp/cryptoupdate
    rm -f /tmp/cryptoupdate
} || printprices | tee /tmp/cryptoupdate

